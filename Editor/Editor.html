<!DOCTYPE html>
<html>
    <head>
        <style>
            * {
                box-sizing: border-box;
            }
            html, body {
                margin: 0;
                padding: 0;
                overflow: hidden;
                font-family: Arial, Helvetica, sans-serif;
            }
            canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: calc(100vw - 512px);
                height: 100vh;
                border-right: 3px solid black;
            }

            #editor {
                position: absolute;
                top: 0;
                right: 0;
                width: 512px;
                height: 100vh;
                padding: 10px;
            }

            #tiles {
                border: 1px dotted grey;
                width: 100%;
                height: 512px;
                overflow: auto;
            }
            .tile {
                width: 64px;
                height: 64px;
                display: inline-block;
                margin: 5px;
                border: 1px solid black;
                background-size: cover;
            }
            .tile[selected=true]{
                border: 2px solid rgba(0, 255, 0, 255);
            }
            .tile:hover{
                cursor: pointer;
                border: 2px solid red;
                color: red;
            }

            #tileeditor {
                padding: 10px;
                height: 512px;
                border: 1px dotted grey
            }

            #layer {
                position: absolute;
                top:10px;
                right: 524px
            }
        </style>
    </head>
    <body>
        <canvas>You need HTML 5</canvas>
        <label id="layer">
            <input type="number" value=1 min=0 max=3 onchange="changeLayer(event)"/> Layer
        </label>
        <div id="editor">
            <h3>Tiles</h3>
            <div id="tiles">
                <div class="tile" style="background-image: url(Add.png)" onclick="newTile(event)"></div>
            </div>
            <h3>Editor</h3>
            <div id="tileeditor">
            </div>
        </div>
        <script>
            const canv = document.querySelector("canvas");
            const ctx = canv.getContext('2d');
            const tWidth = 64;
            const tHeight = 64;

            let xMax = 10;
            let yMax = 10;

            let grid = [];
            let entities = [];
            let editor = null;
            let player = {
                x: 0,
                y: 0,
                lookDir: 1 // 0 = up, 1 = right, 2 = down, 3 = left
            };

            // Key Codes
            const K_UP = 38;
            const K_LEFT = 37;
            const K_RIGHT = 39;
            const K_DOWN = 40;
            const K_SHIFT = 16;
            const K_CTRL = 17;
            const K_P = 80;

            let camera = {
                x: 0,
                y: 0
            };
            
            let mousePos = {
                x: 0,
                y: 0
            };

            let keyMap = [];

            function main() {
                init();
                setInterval(() => {
                    ctx.clearRect(0, 0, canv.width, canv.height);
                    draw();
                    update();
                }, 16);
            }

            function init() {
                for(let i = 0; i < 256; i++){
                    grid[i] = new Array(256);
                }
                editor = new EditorState;
                canv.width = window.innerWidth - 512;
                canv.height = window.innerHeight;
                document.addEventListener("keydown", keyDown);
                document.addEventListener("keyup", keyUp);
                canv.addEventListener("click", click);
                canv.addEventListener("contextmenu", editTile);
                canv.addEventListener("mousedown", middleClick);
                canv.addEventListener("mousemove", mouseMove);
            }

            function draw() {
                drawGrid();
                drawTiles();
                drawPlayer();
                drawCursor();
            }

            function update() {
                checkMove();
            }

            // Events

            function keyDown(e) {
                keyMap[e.keyCode] = true;
                if(keyMap[K_CTRL]){
                    if(e.keyCode == K_LEFT){
                        if(keyMap[K_SHIFT]){
                            console.log("left");
                            xMax--;
                            xMax = Math.max(xMax, 0);
                        } else {
                            player.lookDir = 3;
                        }
                    } else if(e.keyCode == K_RIGHT){
                        if(keyMap[K_SHIFT]){
                            xMax++;
                            xMax = Math.min(xMax, 255);
                        } else {
                        player.lookDir = 1;
                        }
                    } else if(e.keyCode == K_UP){
                        if(keyMap[K_SHIFT]){
                            yMax++;
                            yMax = Math.min(yMax, 255);
                        }else{
                            player.lookDir = 0;
                        }
                    } else if(e.keyCode == K_DOWN){
                        if(keyMap[K_SHIFT]){
                            yMax--;
                            yMax = Math.max(0, yMax);
                        }else {
                            player.lookDir = 2;
                        }
                    }
                }
                if(e.keyCode == K_P){
                    let x = mousePos.x + camera.x;
                    let y = mousePos.y + camera.y;
                    let tileX = parseInt(x/tWidth);
                    let tileY = parseInt(y/tHeight);
                    player.x = tileX;
                    player.y = tileY;
                }
            }

            function keyUp(e) {
                keyMap[e.keyCode] = false;
            }

            function mouseMove(e) {
                mousePos.x = e.clientX;
                mousePos.y = e.clientY;
            }

            function click(e) {
                let x = mousePos.x + camera.x;
                let y = mousePos.y + camera.y;
                let tileX = parseInt(x/tWidth);
                let tileY = parseInt(y/tHeight);
                let t = grid[tileX][tileY] ?? new Tile(tileX, tileY);
                idx = "wallTexture";
                switch(editor.layer) {
                    case 0: idx = "floorTexture"; break;
                    case 1: idx = "wallTexture"; break;
                    case 2: idx = "ceilingTexture"; break;
                }
                t[idx] = editor.tile;
                grid[tileX][tileY] = t;
                
                editor.selectedTile = t;
                openEditor(t);
            }

            function middleClick(e) {
                let x = mousePos.x + camera.x;
                let y = mousePos.y + camera.y;
                let tileX = parseInt(x/tWidth);
                let tileY = parseInt(y/tHeight);
                
                if(e.button === 1){
                    e.preventDefault();
                    grid[tileX][tileY] = undefined;
                }
            }

            function editTile(e) {
                e.preventDefault();
                let x = mousePos.x + camera.x;
                let y = mousePos.y + camera.y;
                let tileX = parseInt(x/tWidth);
                let tileY = parseInt(y/tHeight);

                let tile = grid[tileX][tileY]
                if(!tile) {
                    return;
                }
                editor.selectedTile = tile;
                openEditor(tile)
            }

            // Drawing

            function drawGrid() {
                for(let i = 0; i < canv.width; i += tWidth){
                    let iMod = i - (camera.x % tWidth);
                    ctx.strokeStyle = "black";
                    ctx.beginPath()
                    ctx.moveTo(iMod, 0);
                    ctx.lineTo(iMod, canv.height);
                    ctx.stroke();
                    for(let j = 0; j < canv.height + tHeight; j += tHeight){
                        let jMod = j - (camera.y % tHeight);
                        ctx.beginPath();
                        ctx.moveTo(0, jMod);
                        ctx.lineTo(canv.width, jMod);
                        ctx.stroke();
                    }
                }

                ctx.beginPath();
                let x = ((xMax * tWidth) - camera.x);
                let y = ((yMax * tHeight) - camera.y);

                ctx.lineWidth = 4;
                ctx.strokeStyle = "cornflowerblue";
                ctx.moveTo(x, 0);
                ctx.lineTo(x, y);
                ctx.moveTo(0, y);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.lineWidth = 1;
                ctx.strokeStyle = "black";
            }

            function drawTiles() {
                for(let i = 0; i < 256; i++){
                    for(let j = 0; j < 256; j++){
                        let wall = grid[i][j];
                        if(!wall)
                            continue;
                        let idx = 0;
                        switch(editor.layer) {
                            case 0: idx = wall.floorTexture; break;
                            case 1: idx = wall.wallTexture; break;
                            case 2: idx = wall.ceilingTexture; break;
                        }

                        let x = (i * tWidth) - camera.x;
                        let y = (j * tHeight) - camera.y;

                        ctx.beginPath();
                        ctx.lineWidth = 4;
                        ctx.strokeStyle = "black";
                        ctx.rect(x, y, tWidth, tHeight);
                        ctx.stroke();
                        ctx.lineWidth = 1;

                        const img = editor.tiles[idx]
                        if(!img){
                            continue;
                        }

                        ctx.drawImage(img, x, y, tWidth, tHeight);
                        if(wall === editor.selectedTile){
                            ctx.beginPath();
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = "rgb(0, 255, 0)";
                            ctx.rect(x, y, tWidth, tHeight);
                            ctx.stroke();
                            ctx.lineWidth = 1;
                        }
                    }
                }
            }
            function drawPlayer() {
                ctx.beginPath();
                let x = (player.x * tWidth) - camera.x + (tWidth/2);
                let y = (player.y * tHeight) - camera.y + (tHeight/2)
                ctx.arc(
                    x,
                    y,
                    tWidth/2 - 4,
                    0,
                    Math.PI * 2
                );
                ctx.fillStyle = "white";
                ctx.fill();
                ctx.moveTo(x, y);
                switch(player.lookDir) {
                    case 0: ctx.lineTo(x, y - tWidth/2 + 4); break;
                    case 1: ctx.lineTo(x + tWidth/2 - 4, y); break;
                    case 2: ctx.lineTo(x, y + tWidth/2 - 4); break;
                    case 3: ctx.lineTo(x - tWidth/2 + 4, y); break;
                }
                ctx.stroke();
            }

            function drawCursor() {
                let x = mousePos.x + (camera.x % tWidth);
                let y = mousePos.y + (camera.y % tHeight);
                let highlightX = (parseInt(x/tWidth) * tWidth) - (camera.x % tWidth);
                let highlightY = parseInt(y/tHeight) * tHeight - (camera.y % tHeight);;
                ctx.strokeStyle = "red";
                ctx.lineWidth = 3;  
                ctx.lineStyle = "dotted";
                ctx.beginPath();
                ctx.rect(highlightX, highlightY, tWidth, tHeight)
                ctx.stroke();
                ctx.strokeStyle = "black";
                ctx.lineWidth = 1;

            }

            // Editing

            class EditorState {
                constructor(){
                    this.layer = 1;
                    this.tile = 0;
                    this.ceiling = 0;
                    this.floor = 0;
                    this.entity = null;
                    this.tiles = [];
                    this.selectedTile = null;
                }

                get isTiling(){ return this.entity == null && this.tile != null; }
                get isEntityPlacing() { return !isTiling(); }

            }

            class Tile {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.wallTexture = 0;
                    this.floorTexture = 0;
                    this.ceilingTexture = 0;
                    this.zone = 0;
                    this.isDoor = false;
                    this.key = 0;
                }
            }

            function checkMove() {
                let speed = keyMap[K_SHIFT] ? 10 : 5;
                if(keyMap[K_LEFT]){
                    if(!keyMap[K_CTRL]) {
                        if(camera.x > 0)
                            camera.x -= speed;
                    }
                }
                if(keyMap[K_RIGHT]){
                    if(!keyMap[K_CTRL]){
                        camera.x += speed;
                    }
                }
                if(keyMap[K_DOWN]){
                    if(!keyMap[K_CTRL]){
                        camera.y += speed;
                    }
                }
                if(keyMap[K_UP]){
                    if(!keyMap[K_CTRL]){
                        if(camera.y > 0)
                            camera.y -= speed;
                    }
                }
            }

            function selectTile(e) {
                let tileNum = parseInt(e.target.getAttribute("tileNum"));
                editor.tile = tileNum;
                editor.entity = null;
                e.target.setAttribute("selected", true);
            }

            function newTile(e) {
                const i = document.createElement("input");
                i.setAttribute("type", "file");
                i.setAttribute("multiple", true);
                i.addEventListener("change", _e => {
                    let files = i.files;
                    let reader = new FileReader();
                    let idx = 0;
                    reader.onload = fe => {
                        let tile = document.createElement("div");
                        tile.classList.add("tile");
                        tile.style.backgroundImage = `url(${fe.target.result})`;
                        let tileNum = parseInt(files[idx].name.replace(".bmp", ""));
                        let img = new Image();
                        img.onload = _img => {
                            console.log("loaded")
                            console.log(img.target);
                            editor.tiles[tileNum] = img;
                        }
                        img.src = fe.target.result;

                        tile.addEventListener("click", selectTile);
                        tile.setAttribute("tileNum", tileNum);
                        e.target.parentNode.insertBefore(tile, e.target);
                        if(idx < files.length - 1)
                            reader.readAsDataURL(files[++idx])
                    }
                    reader.readAsDataURL(files[idx]);
                })
                i.click();
            }

            function openEditor(tile) {
                const tileEditor = document.getElementById("tileeditor");
                tileEditor.setAttribute("tileX", tile.x);
                tileEditor.setAttribute("tile", tile.y);

                let title = document.createElement("h2");
                title.innerHTML = `Tile ${tile.x}, ${tile.y}`;

                let isDoor = document.createElement("input");
                isDoor.setAttribute("type", "checkbox");
                isDoor.setAttribute("id", "isDoor");
                if(tile.isDoor)
                    isDoor.setAttribute("checked", true);

                let isDoorLabel = document.createElement("label");
                isDoorLabel.innerHTML += "Is Door? ";
                isDoorLabel.appendChild(isDoor);
                
                let keyType = document.createElement("input");
                keyType.setAttribute("type", "number");
                keyType.setAttribute("min", 0);
                keyType.setAttribute("max", 3);
                keyType.value = tile.key
                keyType.setAttribute("id", "keyType");

                let keyTypeLabel = document.createElement("label");
                keyTypeLabel.innerHTML = "Key type ";
                keyTypeLabel.append(keyType);

                let saveButton = document.createElement("button");
                saveButton.innerHTML = "Save";
                saveButton.addEventListener("click", () => saveTile(tile));

                tileEditor.innerHTML = "";
                tileEditor.appendChild(title);
                tileEditor.appendChild(document.createElement("hr"));
                tileEditor.appendChild(isDoorLabel);
                tileEditor.appendChild(document.createElement("hr"));
                tileEditor.appendChild(keyTypeLabel);
                tileEditor.appendChild(document.createElement("hr"));
                tileEditor.appendChild(saveButton);
            }

            function saveTile(tile) {
                const isDoor = document.getElementById("isDoor");
                tile.isDoor = isDoor.checked;

                const keyType = document.getElementById("keyType");
                tile.key = keyType.value;
            }

            function changeLayer(e) {
                editor.layer = parseInt(e.target.value);
            }

            function saveMap() {
                
                let bin = new Uint16Array(new ArrayBuffer(xMax * yMax * 8 + 6)); // 4 instead of 3 to fit the bytes
                let idx = 0;
                console.log(editor.tiles.length)
                bin[idx++] = editor.tiles.length;
                //console.log(bin[0])
                bin[idx++] = xMax;
                //console.log(bin[1])
                bin[idx++] = yMax;
                //console.log(bin[2])
                for(let i = 0; i < xMax; i++) {
                    for(let j = 0; j < yMax; j++) {
                        let wall = grid[i][j];
                        if(!wall)
                            wall = new Tile(i, j);
                            //wall = new Tile(i, j);
                        bin[idx++] = wall.wallTexture;
                        bin[idx++] = wall.ceilingTexture;
                        bin[idx++] = wall.floorTexture;
                        bin[idx++] = (wall.zone << 8) | ((wall.isDoor ? 1 : 0) | (wall.key << 1));
                        console.log(idx * 2);
                    }
                }
                console.log(bin);
                let blob = new Blob([bin]);
                blob.lastModifiedDate = new Date();
                blob.name = "map.bin";

                var url = URL.createObjectURL(blob);
                var link = document.createElement("a");
                link.href = url;
                link.download = "map.bin";
                link.click();
            }

            main();

        </script>
    </body>
</html>